# Отчёт по рефакторингу `process_checkout`

## Найденные проблемы качества кода

### 1. Слишком длинная функция
- `process_checkout` выполняла сразу несколько задач:
  - разбор входных данных
  - валидацию
  - расчёт subtotal
  - расчёт скидки
  - расчёт налога
  - формирование результата
- Это нарушало принцип **Single Responsibility** и затрудняло понимание кода.

### 2. Смешение уровней абстракции
- В одной функции соседствовали:
  - бизнес-правила (скидки, налог)
  - техническая логика (валидация структуры запроса)
  - арифметические операции
- Код было сложно читать «как историю».

### 3. Магические числа
- В коде присутствовали неочевидные константы:
  - `0.10`, `0.20`, `0.05`
  - `200`, `100`
  - `50`, `10`
  - `0.21`
- Без контекста было непонятно, что они означают и где используются ещё.

### 4. Сложная логика скидок
- Логика расчёта скидок была реализована в виде вложенных `if/elif`,
  что затрудняло добавление новых правил и тестирование существующих.

### 5. Дублирование знаний
- Правила валидации элементов заказа были «зашиты» прямо в цикл,
  из-за чего их было сложно переиспользовать и расширять.


## Применённые рефакторинги

### 1. Extract Function
Выделены отдельные функции:
- `parse_request`
- `validate_request`
- `validate_item`
- `calculate_subtotal`
- `calculate_discount`
- `calculate_tax`

Каждая функция отвечает за одну логическую операцию.

### 2. Introduce Named Constants
Все магические числа вынесены в именованные константы:
- ставки скидок
- пороги subtotal
- фиксированные скидки
- ставка налога
- валюта по умолчанию

Это сделало бизнес-правила явными.

### 3. Упорядочивание сценария (Top-Down Reading)
`process_checkout` теперь читается как сценарий:
1. разбор запроса
2. валидация
3. расчёт subtotal
4. расчёт скидки
5. расчёт налога
6. формирование ответа

### 4. Упрощение условий
- Использованы ранние возвраты
- Убраны избыточные `else`
- Минимизированы вложенные конструкции

### 5. Сохранение внешнего поведения
- Сигнатуры функций и формат результата сохранены
- Все существующие тесты продолжают проходить без изменений


## Что стало проще читать и менять

### Проще читать
- Основная функция стала короткой и декларативной
- Каждая строка описывает *что* происходит, а не *как*
- Бизнес-логика не теряется среди проверок

### Проще менять
- Добавление нового купона — локально в `calculate_discount`
- Изменение налоговой ставки — в одной константе
- Изменение правил валидации — без риска сломать расчёты
- Переиспользование логики в других сценариях

### Проще тестировать
- Каждую часть можно тестировать изолированно
- Ошибки локализуются быстрее
- Тесты становятся более точечными и понятными


## Итог

Рефакторинг превратил монолитную процедуру в набор
чётко разделённых, читаемых и расширяемых компонентов,
при этом полностью сохранив поведение системы.
